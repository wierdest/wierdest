#!/usr/bin/env node
const app = require('../app');
const debug = require('debug')('wierdest:server');
const http = require('http');
const { Server } = require('socket.io');
const uuid = require('uuid');

// Create HTTP server
const server = http.createServer(app);

// Create the Socket.IO server
const io = new Server(server, {
  cors: {
    origin: "*", // Allow all origins (adjust as needed for security)
    methods: ["GET", "POST"]
  }
});

io.on('connection', (socket) => {
  const userId = uuid.v4();
  console.log('User connected with ID ', userId);

  // Send 'init' event with userId
  socket.emit('init', { userId });

  // Listen for 'pos' events from clients
  socket.on('pos', (data) => {
    io.emit('draw', { userId, pos: data });
  });

  socket.on('disconnect', () => {
    console.log(`User ${userId} disconnected`);
  });
});

// Start the server
server.listen(process.env.PORT || 3000, () => {
  console.log(`Server running on http://localhost:${server.address().port}`);
});

debug('Server is configured');
